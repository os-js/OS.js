#!/usr/bin/env php
<?php
define('__CLI_SCRIPT', true);
$is_cli = php_sapi_name();

if ( $is_cli == "cli" ) {
  require 'backend/api.php';
} else {
  require '../backend/api.php';
}

$combined = Array();
$dirs = explode(":", APPDIR);
foreach ( $dirs as $path ) {
  $basedir = basename($path);

  foreach ( scandir($path) as $i ) {
    if ( $i == "." || $i == ".." ) continue;
    $file = "{$path}/{$i}/package.json";
    if ( file_exists($file) && ($c = file_get_contents($file)) ) {
      if ( $j = json_decode($c, true) ) {
        $k = key($j);
        $data = current($j);

        if ( isset($data['enabled']) && ($data['enabled'] === false || $data['enabled'] === 'false' ) ) {
          continue;
        }

        foreach ( $data['preload'] as $pi => $pp ) {
          $data['preload'][$pi]['src'] = "/{$basedir}/{$i}/{$pp['src']}";
        }

        $data['path']    = "{$basedir}/{$i}";
        $data['iter']    = $i;
        $combined[$k]    = $data;
      }
    }
  }
}

ksort($combined);

if ( $size = file_put_contents(ROOTDIR . "/packages.json", json_encode($combined)) ) {
  $count = sizeof($combined);
  print "Wrote package manifest: {$size}b ($count apps)\n";
  exit(0);
}

print "Failed creating manifest :/\n";
exit(1);

?>
